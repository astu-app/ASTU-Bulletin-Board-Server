# Логгирование
В системе ведется логгирование действий над следующими объектами:
* [объявления](#объявления)
* [опросы](#опросы)
* [файлы](#файлы)
* [категории объявлений](#категории-объявлений)
* [пользователи](#аккаунты-и-пользователи)
* [группы пользователей](#группы-пользователей)

Каждая запись лога содержит момент редактирования в часовом поясе сервера приложения.

## Объявления
В системе ведется логгирование полной цепочки изменения объявлений за весь период его жизни.

Логгируются следующие операции:
* [создание](#лог-создания)
* [редактирование](#лог-редактирования)
* [сокрытие](#лог-сокрытия)
* [восстановление скрытого объявления](#лог-восстановление-скрытого-объявления)
* [удаление](#лог-удаления-объявления)

Структура таблицы с логами объявления:

| момент | id объявления | id пользователя | детали | тип операции |
|--------|---------------|-----------------|--------|--------------|
|        |               |                 |        |              |

### Лог создания
При создании объявления логгируются следующие данные:
* момент создания
* id объявления
* id создателя
* значения каждого атрибута в [указанном формате](#формат-лога-создания-объекта)
* тип операции "CREATED"

### Лог редактирования
Логгируемые при редактировании объявления данные зависят от произведенных операций.

В лог включаются следующая информация:
* момент редактирования
* id объявления
* id редактора
* новое и старое значение для каждого измененного атрибута в [указанном формате](#формат-лога-редактирования-объекта)
* тип операции "UPDATED"

### Лог сокрытия
При автоматическом сокрытии объявления логгируются следующие данные:
* момент сокрытия
* id объявления
* тип операции "HIDDEN AUTOMATICALLY" 

При ручном сокрытии объявления логгируются следующие данные:
* момент сокрытия
* id объявления
* id скрывшего пользователя
* тип операции "HIDDEN MANUALLY"

### Лог восстановление скрытого объявления
При автоматическом восстановлении скрытого объявления логгируются следующие данные:
* момент восстановления
* id объявления
* тип операции "RESTORED AUTOMATICALLY"

При ручном восстановлении скрытого объявления логгируются следующие данные:
* момент восстановления
* id объявления
* id восстановившего пользователя
* тип операции "RESTORED MANUALLY"

### Лог удаления объявления
При удалении скрытого объявления логгируются следующие данные:
* момент удаления
* id объявления
* id удалившего пользователя
* тип операции "DELETED"



## Опросы
Так как опрос является сложной сущностью, состоящей из вопросов и вариантов ответов этих опросов, логгирование операций
над опросами включает и логгирование операций над вопросами и вариантами ответов. 

В системе ведется логгирование следующих операций над опросами:
* [создание опроса](#лог-создания-опроса)
* [закрытие опроса](#лог-закрытия-опроса)
* [выгрузка результатов опроса](#лог-выгрузки-результатов-опроса)

Структура таблицы с логами опроса:

| момент | id опроса | id пользователя | тип операции |
|--------|-----------|-----------------|--------------|
|        |           |                 |              |

Структура таблицы с логами вопроса:

| момент | id опроса | id вопроса | тип операции |
|--------|-----------|------------|--------------|
|        |           |            |              |

Структура таблицы с логами варианта ответа:

| момент | id вопроса | id варианта ответа | тип операции |
|--------|------------|--------------------|--------------|
|        |            |                    |              |

### Лог создания опроса
При создании опроса логгируются следующие данные:
* момент создания
* id создателя
* id опроса
* тип операции "CREATED"

Момент создания и id создателя опроса не логгируются, так как они совпадают с соответствующими данными в таблице с 
логами объявления, к которому привязан опрос.

При создании опроса создаются и вопросы. Лог создания вопроса включает следующие данные:
* момент создания
* id опроса
* id вопроса
* тип операции "CREATED"

При создании вопроса создаются варианты ответов. Лог создания варианта ответа включает следующие данные:
* момент создания
* id вопроса
* id варианта ответа
* тип операции "CREATED"

### Лог закрытия опроса
При закрытии опроса закрываются и опросы, которые относятся к опросу.

Лог закрытия опроса включает:
* момент закрытия опроса
* id опроса
* id закрывшего опроса пользователя
* тип операции "CLOSED"

Лог закрытия вопроса включает:
* момент закрытия вопроса
* id вопроса
* id опроса, к которому относится вопрос
* тип операции "CLOSED"

### Лог выгрузки результатов опроса
При выгрузке результатов опроса логгируются следующие данные:
* момент выгрузки
* id опроса
* id выгрузившего результаты пользователя
* тип операции "RESULTS DOWNLOADING"



## Файлы
В системе ведется логгирование следующих операций над файлами:
* [первичная загрузка файла](#лог-первичной-загрузки)
* [повторная загрузка файла](#лог-повторной-загрузки)
* [удаление файла с сервера](#лог-удаления-файла)

Структура таблицы с логами файлов:

| момент | id файла | id пользователя | тип операции |
|--------|----------|-----------------|--------------|
|        |          |                 |              |

### Лог первичной загрузки
При первичной загрузке файла на сервер логгируются следующие данные:
* момент окончания загрузки файла на сервер
* id файла
* id загрузившего пользователя
* тип операции "UPLOADED"

### Лог повторной загрузки
При попытке повторной загрузки файла на сервер ведется логгирование следующих данных:
* момент попытки повторной загрузки файла
* id оригинального файла
* id совершившего попытку пользователя
* тип операции "RE-UPLOAD TRY"

### Лог удаления файла
При попытке удаления файла с сервера логгируются следующие данные:
* момент удаления файла с сервера
* id файла
* тип операции "DELETED"



## Категории объявлений
Для категорий объявлений ведется логгирование следующих операций:
* [создание](#лог-создания-категории-объявлений)
* [редактирование](#лог-редактирования-категории-объявлений)
* [удаление](#лог-удаления-категории-объявлений)

Структура таблицы с логами категорий объявлений:

| момент | id категории объявлений | id пользователя | детали | тип операции |
|--------|-------------------------|-----------------|--------|--------------|
|        |                         |                 |        |              |

### Лог создания категории объявлений
При создании категории объявлений логгируются следующие данные:
* момент создания
* id категории объявлений
* id создавшего пользователя
* значения каждого атрибута в [указанном формате](#формат-лога-создания-объекта)
* тип операции "CREATED"

### Лог редактирования категории объявлений
При редактировании категории объявлений логгируются следующие данные:
* момент редактирования
* id категории объявлений
* id отредактировавшего пользователя
* новое и старое значение для каждого измененного атрибута в [указанном формате](#формат-лога-редактирования-объекта)
* тип операции "UPDATED"

### Лог удаления категории объявлений
При удалении категории объявлений логгируются следующие данные:
* момент удаления
* id категории объявлений
* id удалившего пользователя
* тип операции "DELETED"



## Аккаунты и пользователи
Для пользователей ведется логгирование следующих операций:
* [создание пользователя](#лог-создания-аккаунта)
* [регистрация пользователя в системе](#лог-регистрации-пользователя-в-системе)
* [изменение имени](#лог-изменения-имени-пользователя)

Структура таблицы с логами пользователей:

| момент | id пользователя | детали | тип операции |
|--------|-----------------|--------|--------------|
|        |                 |        |              |

### Лог создания аккаунта
Создание аккаунта в базе данных происходит при первичном импорте из базы данных в автоматическом режиме.
При первичном импорте пользователя из базы данных университета логгируются следующие данные:
* момент создания
* id пользователя
* значения каждого атрибута в [указанном формате](#формат-лога-создания-объекта)
* тип операции "CREATED"

### Лог регистрации пользователя в системе
При прохождении регистрации пользователя в системе логгируются следующие данные:
* момент регистрации
* id пользователя
* новое значение логина в [указанном формате](#формат-лога-создания-объекта)
* тип операции "REGISTERED"

### Лог изменения имени пользователя
Изменение имени пользователя в системе происходит только при импорте измененного имени пользователя в базе данных 
университета в автоматическом режиме. 
При изменении имени пользователя логгируются следующие данные:
* момент изменения имени
* id пользователя 
* новое и старое значение имени в [указанном формате](#формат-лога-редактирования-объекта)
* тип операции "NAME CHANGED"



## Группы пользователей
Для групп пользователей ведется логгирование следующих операций:
* [создание](#лог-создания-группы-пользователей)
* [редактирование](#лог-редактирования-группы-пользователей)
* [удаление](#лог-удаления-группы-пользователей)

Структура таблицы с логами групп пользователей:

| момент | id группы пользователей | id пользователя | детали | тип операции |
|--------|-------------------------|-----------------|--------|--------------|
|        |                         |                 |        |              |

### Лог создания группы пользователей
При создании группы пользователей логгируются следующие данные:
* момент создания
* id группы пользователей
* id создавшего пользователя
* значения каждого атрибута в [указанном формате](#формат-лога-создания-объекта)
* тип операции "CREATED"

### Лог редактирования группы пользователей
Редактирование группы пользователей подразумевает выполнение одной или нескольких из следующих операций:
* [редактирование названия](#лог-редактирования-названия-группы-пользователей)
* [действия с администратором](#лог-действий-с-администратором-группы-пользователей)
* [действия с участниками](#лог-действий-с-участниками-группы-пользователей) 

#### Лог редактирования названия группы пользователей
При редактировании названия группы пользователей логгируются следующие данные:
* момент редактирования
* id группы пользователей
* id отредактировавшего пользователя
* новое и старое значение для названия в [указанном формате](#формат-лога-редактирования-объекта)
* тип операции "NAME CHANGED"

#### Лог действий с администратором группы пользователей
В системе предусмотрены следующие действия над администратором группы пользователей:
* назначение нового администратора
* удаление администратора

При выполнении действий с администратором группы пользователей логгируются следующие данные:
* момент выполнения действия
* id группы пользователей
* id отредактировавшего пользователя
* новое и старое значение для названия в [указанном формате](#формат-лога-редактирования-объекта)
* тип операции: 
  * "ADMIN SET" при установлении нового администратора
  * "ADMIN REMOVED" при удалении администратора

#### Лог действий с участниками группы пользователей
В системе предусмотрены следующие действия с участниками группы пользователей:
* добавление участников
* исключение участников
* редактирование прав участников

Лог добавления и исключения участника группы пользователей содержит следующие данные:
* момент выполнения действия
* id группы пользователей
* id отредактировавшего пользователя
* список добавленных или исключенных пользователей в [указанном формате](#формат-лога-добавления-и-исключения-пользователей-из-группы-пользователей)
* тип операции:
  * "USERS ADDED" при добавлении участников
  * "USERS EXCLUDED" при исключении участников

Лог редактирования прав участника группы пользователей содержит следующие данные:
* момент выполнения действия
* id группы пользователей
* id отредактировавшего участника
* новые и старые права в [указанном формате](#формат-лога-редактирования-прав-пользователя)
* пип операции "RIGHTS CHANGED"

#### Формат лога добавления и исключения пользователей из группы пользователей
В базе данных лог добавления и исключения пользователей записывается в следующем формате:
```json
{
  "users": [
    "id_1",
    "id_2",
    "id_n"
  ]
}

```
id_1, id_2, id_n - идентификаторы пользователей, над которыми была произведена операция

#### Формат лога редактирования прав пользователя
В базе данных лог редактирования прав пользователя записывается в следующем формате:
```json
{
  "user_id": {
    "old_rights": {
      "right_1": "*val*",
      "right_2": "*val*",
      "right_n": "*val*"
    },
    "new_rights": {
      "right_1": "*val*",
      "right_2": "*val*",
      "right_n": "*val*"
    }
  }
}
```

*old_rights* содержит права пользователя до редактирования, *new_rights* - после редактирования. 
Оба атрибута содержат весь набор прав пользователя, а не только изменившиеся.

### Лог удаления группы пользователей
При удалении группы пользователей логгируются следующие данные:
* момент удаления
* id группы пользователей
* id удалившего пользователя
* тип операции "DELETED"





## Формат лога создания объекта
В базе данных лог создания объекта записывается в формате json в следующем виде:
```json
{
  "attribute_1_name": "*val*",
  "attribute_2_name": "*val*",
  "attribute_n_name": "*val*"
}
```
*attribute_\*_name* - название атрибута таблицы, *val* - значение атрибута.



## Формат лога редактирования объекта
В базе данных лог редактирования объекта записывается в формате json в следующем виде:
```json
{
  "updated_attribute_name": {
    "old_value": "*old val*",
    "new_value": "*new val*"
  },
  "attribute_with_given_value_name": {
    "old_value": null,
    "new_value": "*new val*"
  },
  "attribute_with_deleted_value_name": {
    "old_value": "*old val*",
    "new_value": null
  }
}
```
*updated_attribute_name*, *attribute_with_given_value_name*, *attribute_with_deleted_value_name* - атрибуты с 
отредактированным значением.

При первом задании значения атрибута в *old_value* содержится *null*, а в *new_value* - заданное значение
(*attribute_with_given_value_name*).

При удалении значения атрибута в *old_value* содержится удаленное значение, а в *new_value* - *null* 
(*attribute_with_deleted_value_name*).

